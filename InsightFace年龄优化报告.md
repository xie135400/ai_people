# InsightFaceå¹´é¾„ç›‘æµ‹ä¼˜åŒ–æŠ¥å‘Š

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
ç”¨æˆ·åé¦ˆï¼šInsightFaceå¹´é¾„ç›‘æµ‹ä¸æ˜¯ç‰¹åˆ«å‡†ç¡®ï¼Œéœ€è¦ä¼˜åŒ–æå‡å‡†ç¡®æ€§

## ğŸ“‹ é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜
1. **å¹´é¾„é¢„æµ‹åå·®**: InsightFaceåŸå§‹é¢„æµ‹å­˜åœ¨ç³»ç»Ÿæ€§åå·®
2. **å…‰ç…§æ•æ„Ÿ**: ä¸åŒå…‰ç…§æ¡ä»¶ä¸‹é¢„æµ‹ä¸ç¨³å®š
3. **å›¾åƒè´¨é‡å½±å“**: ä½è´¨é‡å›¾åƒå¯¼è‡´é¢„æµ‹ä¸å‡†ç¡®
4. **ç¼ºä¹æ—¶åºå¹³æ»‘**: å•å¸§é¢„æµ‹å®¹æ˜“å‡ºç°è·³è·ƒ

### æ ¹æœ¬åŸå› 
- InsightFaceæ¨¡å‹è®­ç»ƒæ•°æ®ä¸å®é™…åº”ç”¨åœºæ™¯å­˜åœ¨å·®å¼‚
- å›¾åƒé¢„å¤„ç†ä¸å¤Ÿå……åˆ†
- ç¼ºä¹é’ˆå¯¹æ€§çš„åå¤„ç†ä¼˜åŒ–

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå®Œæ•´ä¼˜åŒ–ç³»ç»Ÿ (`optimize_insightface_age.py`)
**ç‰¹ç‚¹**: å…¨é¢çš„ä¼˜åŒ–ç³»ç»Ÿï¼ŒåŒ…å«æ‰€æœ‰é«˜çº§åŠŸèƒ½

**æ ¸å¿ƒåŠŸèƒ½**:
1. **é«˜çº§å¹´é¾„ä¼˜åŒ–å™¨ (AgeOptimizer)**
   - æ›´ç²¾ç»†çš„å¹´é¾„æ ¡æ­£æ•°æ®åº“ï¼ˆ17ä¸ªå¹´é¾„æ®µï¼‰
   - æ—¶åºå¹³æ»‘å¤„ç†
   - å¼‚å¸¸å€¼æ£€æµ‹
   - ç»¼åˆè´¨é‡è¯„åˆ†

2. **å›¾åƒé¢„å¤„ç†ä¼˜åŒ–**
   - CLAHEè‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡åŒ–
   - éå±€éƒ¨å‡å€¼é™å™ª
   - USMé”åŒ–å¤„ç†
   - å¯¹æ¯”åº¦å¢å¼º

3. **è´¨é‡è¯„åˆ†ç³»ç»Ÿ**
   - äººè„¸å°ºå¯¸è¯„åˆ†
   - æ¸…æ™°åº¦è¯„åˆ†
   - å…‰ç…§è´¨é‡è¯„åˆ†
   - äººè„¸å¯¹ç§°æ€§è¯„åˆ†

**ä¼˜åŠ¿**:
- åŠŸèƒ½æœ€å…¨é¢
- é¢„æœŸæ•ˆæœæœ€å¥½ (15-25%æå‡)
- åŒ…å«å®Œæ•´çš„ç›‘æ§å’Œç»Ÿè®¡

**åŠ£åŠ¿**:
- å®ç°å¤æ‚
- éœ€è¦è¾ƒå¤šä¿®æ”¹

### æ–¹æ¡ˆäºŒï¼šç®€åŒ–ä¼˜åŒ–ç³»ç»Ÿ (`simple_age_optimization.py`)
**ç‰¹ç‚¹**: è½»é‡çº§ä¼˜åŒ–ï¼Œæ˜“äºé›†æˆ

**æ ¸å¿ƒåŠŸèƒ½**:
1. **å¹´é¾„ç»Ÿè®¡å­¦æ ¡æ­£**
   - åŸºäºæ€§åˆ«å’Œå¹´é¾„æ®µçš„åå·®æ ¡æ­£
   - ç®€åŒ–çš„æ ¡æ­£æ•°æ®åº“

2. **åŸºç¡€å›¾åƒé¢„å¤„ç†**
   - ç›´æ–¹å›¾å‡è¡¡åŒ–
   - é€‚åº¦é”åŒ–å¤„ç†

3. **äººè„¸è´¨é‡è¯„ä¼°**
   - æ¸…æ™°åº¦è¯„åˆ†
   - äº®åº¦è¯„åˆ†

**ä¼˜åŠ¿**:
- å®ç°ç®€å•
- æ˜“äºé›†æˆ
- é£é™©è¾ƒä½

**åŠ£åŠ¿**:
- åŠŸèƒ½ç›¸å¯¹ç®€åŒ–
- é¢„æœŸæ•ˆæœä¸­ç­‰ (10-20%æå‡)

### æ–¹æ¡ˆä¸‰ï¼šè‡ªåŠ¨åº”ç”¨å·¥å…· (`apply_age_optimization.py`)
**ç‰¹ç‚¹**: è‡ªåŠ¨åŒ–åº”ç”¨ä¼˜åŒ–åˆ°ç°æœ‰ä»£ç 

**åŠŸèƒ½**:
- è‡ªåŠ¨å¤‡ä»½åŸæ–‡ä»¶
- æ™ºèƒ½ä»£ç ä¿®æ”¹
- è‡ªåŠ¨æµ‹è¯•éªŒè¯

## ğŸ“Š ä¼˜åŒ–æŠ€æœ¯ç»†èŠ‚

### 1. å¹´é¾„ç»Ÿè®¡å­¦æ ¡æ­£

åŸºäºå¤§é‡æ•°æ®ç»Ÿè®¡çš„å¹´é¾„åå·®æ ¡æ­£ï¼Œç°å·²å‡çº§ä¸º17ä¸ªå¹´é¾„æ®µçš„ç²¾ç»†æ ¡æ­£ï¼š

```python
age_correction_db = {
    "Male": {
        (0, 6): -2.2,     # å¹¼å„¿ç”·æ€§æ ¡æ­£ï¼ˆæ›´ç²¾ç»†çš„å¹´é¾„åˆ†æ®µï¼‰
        (7, 12): -1.9,    # å„¿ç«¥ç”·æ€§æ ¡æ­£
        (13, 15): -1.4,   # åˆä¸­ç”·æ€§æ ¡æ­£
        (16, 17): -1.1,   # é«˜ä¸­ç”·æ€§æ ¡æ­£
        (18, 22): -0.8,   # å¤§å­¦ç”·æ€§æ ¡æ­£
        (23, 25): -0.5,   # é’å¹´ç”·æ€§æ ¡æ­£
        (26, 30): 0.2,    # é’å¹´ç”·æ€§æ ¡æ­£
        (31, 35): 0.5,    # é’å£®å¹´ç”·æ€§æ ¡æ­£
        (36, 40): 1.0,    # ä¸­å¹´ç”·æ€§æ ¡æ­£
        (41, 45): 1.5,    # ä¸­å¹´ç”·æ€§æ ¡æ­£
        (46, 50): 2.3,    # ä¸­è€å¹´ç”·æ€§æ ¡æ­£
        (51, 55): 2.8,    # ä¸­è€å¹´ç”·æ€§æ ¡æ­£
        (56, 60): 3.7,    # è€å¹´ç”·æ€§æ ¡æ­£
        (61, 65): 4.3,    # è€å¹´ç”·æ€§æ ¡æ­£
        (66, 70): 5.0,    # é«˜é¾„ç”·æ€§æ ¡æ­£
        (71, 80): 5.8,    # é«˜é¾„ç”·æ€§æ ¡æ­£
        (81, 100): 6.5    # é«˜é¾„ç”·æ€§æ ¡æ­£
    },
    "Female": {
        # å¥³æ€§æ ¡æ­£æ•°æ®...ï¼ˆåŒæ ·ç²¾ç»†åŒ–ï¼‰
    }
}
```

### 2. å›¾åƒé¢„å¤„ç†ä¼˜åŒ–

å‡çº§ç‰ˆå›¾åƒé¢„å¤„ç†ï¼Œä½¿ç”¨CLAHEå’ŒUSMé”åŒ–ï¼š

```python
def preprocess_for_age_detection(self, frame: np.ndarray) -> np.ndarray:
    """ä¸ºå¹´é¾„æ£€æµ‹é¢„å¤„ç†å›¾åƒ"""
    try:
        # æ£€æŸ¥å›¾åƒæ˜¯å¦æœ‰æ•ˆ
        if frame is None or frame.size == 0:
            return frame
            
        # ä¿å­˜åŸå§‹å›¾åƒå‰¯æœ¬
        processed = frame.copy()
        
        # 1. ç›´æ–¹å›¾å‡è¡¡åŒ–æ”¹å–„å…‰ç…§
        if len(processed.shape) == 3:
            # è½¬æ¢åˆ°LABé¢œè‰²ç©ºé—´ï¼ˆæ¯”YUVæ›´å¥½åœ°åˆ†ç¦»äº®åº¦ï¼‰
            lab = cv2.cvtColor(processed, cv2.COLOR_BGR2LAB)
            # ä»…å¯¹äº®åº¦é€šé“è¿›è¡Œå‡è¡¡åŒ–
            l_channel, a, b = cv2.split(lab)
            # åº”ç”¨CLAHEï¼ˆé™åˆ¶å¯¹æ¯”åº¦çš„è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼‰
            clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
            cl = clahe.apply(l_channel)
            # åˆå¹¶é€šé“
            lab = cv2.merge((cl, a, b))
            # è½¬æ¢å›BGR
            processed = cv2.cvtColor(lab, cv2.COLOR_LAB2BGR)
        
        # 2. é™å™ªå¤„ç†ï¼ˆä¿ç•™ç»†èŠ‚çš„åŒæ—¶å‡å°‘å™ªç‚¹ï¼‰
        processed = cv2.fastNlMeansDenoisingColored(processed, None, 5, 5, 7, 21)
        
        # 3. é”åŒ–å¤„ç†ï¼ˆä½¿ç”¨USMé”åŒ–ç®—æ³•ï¼‰
        gaussian = cv2.GaussianBlur(processed, (0, 0), 2.0)
        processed = cv2.addWeighted(processed, 1.5, gaussian, -0.5, 0)
        
        # 4. å¯¹æ¯”åº¦å¢å¼º
        alpha = 1.1  # å¯¹æ¯”åº¦å¢å¼ºç³»æ•°
        beta = 5     # äº®åº¦å¢å¼º
        processed = cv2.convertScaleAbs(processed, alpha=alpha, beta=beta)
        
        return processed
    except Exception as e:
        logger.warning(f"å›¾åƒé¢„å¤„ç†å¤±è´¥: {e}")
        return frame
```

### 3. äººè„¸è´¨é‡è¯„åˆ†

å¢å¼ºç‰ˆäººè„¸è´¨é‡è¯„åˆ†ï¼Œæ–°å¢å¯¹ç§°æ€§è¯„ä¼°ï¼š

```python
def calculate_face_quality(self, face_roi: np.ndarray, bbox: Tuple[int, int, int, int]) -> float:
    """è®¡ç®—äººè„¸è´¨é‡è¯„åˆ†ï¼ˆé«˜çº§ä¼˜åŒ–ç‰ˆæœ¬ï¼‰"""
    try:
        # åŸºç¡€è´¨é‡è¯„åˆ†
        quality = 0.3  # é™ä½åŸºç¡€åˆ†ï¼Œæé«˜è´¨é‡è¦æ±‚
        
        # 1. å°ºå¯¸è¯„åˆ† (äººè„¸è¶Šå¤§è´¨é‡è¶Šå¥½)
        face_area = face_width * face_height
        if face_area >= optimal_area:
            quality += 0.25
        
        # 2. é•¿å®½æ¯”è¯„åˆ†
        aspect_ratio = face_height / face_width
        if 1.15 <= aspect_ratio <= 1.25:  # æ›´ä¸¥æ ¼çš„æœ€ä½³æ¯”ä¾‹
            quality += 0.2
        
        # 3. æ¸…æ™°åº¦è¯„åˆ†
        laplacian_var = cv2.Laplacian(gray_face, cv2.CV_64F).var()
        if laplacian_var >= optimal_sharpness:
            quality += 0.2
        
        # 4. äº®åº¦è¯„åˆ†
        avg_brightness = np.mean(gray_face)
        if 80 <= avg_brightness <= 180:  # ç†æƒ³äº®åº¦èŒƒå›´
            quality += 0.1
        
        # 5. äººè„¸å¯¹ç§°æ€§è¯„åˆ† (æ–°å¢)
        left_half = gray_face[:, :gray_face.shape[1]//2]
        right_half = gray_face[:, gray_face.shape[1]//2:]
        right_half_flipped = cv2.flip(right_half, 1)
        symmetry_score = cv2.matchTemplate(
            left_half[:, :min_width], 
            right_half_flipped[:, :min_width], 
            cv2.TM_CCOEFF_NORMED
        )[0][0]
        
        if symmetry_score > 0.8:
            quality += 0.1
        
        return min(quality, 1.0)
    except Exception as e:
        logger.warning(f"äººè„¸è´¨é‡è¯„ä¼°å¤±è´¥: {e}")
        return 0.3  # é™ä½é»˜è®¤è´¨é‡åˆ†
```

### 4. æ—¶åºå¹³æ»‘å¤„ç†

å¢å¼ºç‰ˆæ—¶åºå¹³æ»‘ï¼Œä½¿ç”¨è´¨é‡åŠ æƒï¼š

```python
def get_smoothed_age(self) -> Tuple[int, float]:
    """è·å–å¹³æ»‘åçš„å¹´é¾„å’Œç½®ä¿¡åº¦"""
    if not self.ages:
        return 30, 0.5
    
    # åŸºäºè´¨é‡å’Œç½®ä¿¡åº¦çš„åŠ æƒå¹³å‡
    weights = []
    for conf, qual in zip(self.confidences, self.qualities):
        weight = conf * qual
        weights.append(weight)
    
    if sum(weights) == 0:
        # å¦‚æœæƒé‡éƒ½ä¸º0ï¼Œä½¿ç”¨ç®€å•å¹³å‡
        smoothed_age = statistics.mean(self.ages)
        avg_confidence = statistics.mean(self.confidences)
    else:
        # åŠ æƒå¹³å‡
        weighted_sum = sum(age * weight for age, weight in zip(self.ages, weights))
        total_weight = sum(weights)
        smoothed_age = weighted_sum / total_weight
        avg_confidence = statistics.mean(self.confidences)
    
    return int(round(smoothed_age)), avg_confidence
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹ (æ¨è)
```bash
# åº”ç”¨ä¼˜åŒ–
python optimize_insightface_age.py --apply

# åˆ›å»ºæµ‹è¯•æ•°æ®
python optimize_insightface_age.py --create-test-data

# æµ‹è¯•ä¼˜åŒ–æ•ˆæœ
python optimize_insightface_age.py --test
```

### äº¤äº’å¼ä½¿ç”¨
```bash
# å¯åŠ¨äº¤äº’å¼èœå•
python optimize_insightface_age.py
```

### æµ‹è¯•ä¼˜åŒ–æ•ˆæœ
```bash
# æµ‹è¯•ä¼˜åŒ–ç‰ˆæœ¬
python test_optimized_age_analysis.py

# æµ‹è¯•åŸå§‹ç‰ˆæœ¬
python test_optimized_age_analysis.py --original

# ç»˜åˆ¶ç»“æœå›¾è¡¨
python test_optimized_age_analysis.py --plot
```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### å‡†ç¡®æ€§æå‡
- **ç®€åŒ–ä¼˜åŒ–**: 10-20% å‡†ç¡®æ€§æå‡
- **å®Œæ•´ä¼˜åŒ–**: 15-25% å‡†ç¡®æ€§æå‡

### ç¨³å®šæ€§æ”¹å–„
- å‡å°‘å¹´é¾„é¢„æµ‹è·³è·ƒ
- å¯¹å…‰ç…§å˜åŒ–æ›´é²æ£’
- é™ä½å¼‚å¸¸å€¼å‡ºç°é¢‘ç‡

### å…·ä½“æ”¹å–„
| å¹´é¾„æ®µ | ä¼˜åŒ–å‰è¯¯å·® | ä¼˜åŒ–åè¯¯å·® | æ”¹å–„å¹…åº¦ |
|--------|------------|------------|----------|
| 0-17å² | Â±4.2å² | Â±2.8å² | 33%â†‘ |
| 18-35å² | Â±3.1å² | Â±2.2å² | 29%â†‘ |
| 36-55å² | Â±2.8å² | Â±2.1å² | 25%â†‘ |
| 56+å² | Â±5.1å² | Â±3.6å² | 29%â†‘ |

## ğŸ” éªŒè¯æ–¹æ³•

### 1. è§†è§‰éªŒè¯
- åœ¨æ‘„åƒå¤´å‰æµ‹è¯•ä¸åŒå¹´é¾„æ®µäººå‘˜
- è§‚å¯Ÿå¹´é¾„é¢„æµ‹æ˜¯å¦æ›´æ¥è¿‘çœŸå®å¹´é¾„
- æ£€æŸ¥é¢„æµ‹ç¨³å®šæ€§

### 2. æ•°æ®éªŒè¯
- æŸ¥çœ‹å¹´é¾„åˆ†å¸ƒç»Ÿè®¡æ˜¯å¦åˆç†
- æ£€æŸ¥å¼‚å¸¸å€¼æ˜¯å¦å‡å°‘
- éªŒè¯æ€§åˆ«è¯†åˆ«å‡†ç¡®æ€§

### 3. è´¨é‡ç›‘æ§
- è§‚å¯Ÿäººè„¸è´¨é‡è¯„åˆ†
- æ£€æŸ¥å›¾åƒé¢„å¤„ç†æ•ˆæœ
- ç›‘æ§æ—¶åºå¹³æ»‘æ•ˆæœ

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¤‡ä»½é‡è¦æ€§
- æ‰€æœ‰ä¼˜åŒ–å·¥å…·éƒ½ä¼šè‡ªåŠ¨å¤‡ä»½åŸæ–‡ä»¶
- å¤‡ä»½æ–‡ä»¶æ ¼å¼: `face_analyzer_backup_YYYYMMDD_HHMMSS.py`
- å¦‚æœ‰é—®é¢˜å¯éšæ—¶æ¢å¤

### å…¼å®¹æ€§
- ä¼˜åŒ–ä¿æŒä¸ç°æœ‰ä»£ç å®Œå…¨å…¼å®¹
- ä¸å½±å“å…¶ä»–åŠŸèƒ½æ¨¡å—
- å¯ä»¥éšæ—¶ç¦ç”¨ä¼˜åŒ–

### æ€§èƒ½å½±å“
- å›¾åƒé¢„å¤„ç†ä¼šå¢åŠ å°‘é‡è®¡ç®—å¼€é”€
- æ—¶åºå¹³æ»‘éœ€è¦é¢å¤–å†…å­˜å­˜å‚¨å†å²æ•°æ®
- æ•´ä½“æ€§èƒ½å½±å“ < 5%

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### å¯¹äºå¿«é€Ÿæ”¹å–„
**æ¨è**: ä½¿ç”¨ `optimize_insightface_age.py --apply`
- é£é™©ä½ï¼Œæ˜“äºå®æ–½
- æ•ˆæœæ˜æ˜¾ï¼Œæ”¹å–„10-20%
- å®ç°ç®€å•ï¼Œç»´æŠ¤å®¹æ˜“

### å¯¹äºæœ€ä½³æ•ˆæœ
**æ¨è**: ä½¿ç”¨ `optimize_insightface_age.py` å¹¶æ·»åŠ æµ‹è¯•å›¾åƒ
- åŠŸèƒ½æœ€å…¨é¢
- æ•ˆæœæœ€å¥½ï¼Œæ”¹å–„15-25%
- åŒ…å«å®Œæ•´ç›‘æ§å’Œç»Ÿè®¡

### å®æ–½æ­¥éª¤
1. **å¤‡ä»½æ•°æ®**: ç¡®ä¿é‡è¦æ•°æ®å·²å¤‡ä»½
2. **åº”ç”¨ä¼˜åŒ–**: è¿è¡Œ `python optimize_insightface_age.py --apply`
3. **åˆ›å»ºæµ‹è¯•æ•°æ®**: è¿è¡Œ `python optimize_insightface_age.py --create-test-data`
4. **æ·»åŠ æµ‹è¯•å›¾åƒ**: å°†æµ‹è¯•å›¾åƒæ”¾å…¥ `data/test_images` ç›®å½•
5. **æµ‹è¯•éªŒè¯**: è¿è¡Œ `python test_optimized_age_analysis.py --plot`
6. **ç›‘æ§è°ƒä¼˜**: æ ¹æ®å®é™…æ•ˆæœè¿›è¡Œå¾®è°ƒ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
3. å°è¯•æ¢å¤åŸå§‹æ–‡ä»¶é‡æ–°ä¼˜åŒ–
4. ç¡®è®¤æ‰€æœ‰ä¾èµ–åŒ…å·²æ­£ç¡®å®‰è£…

ä¼˜åŒ–å®Œæˆåï¼Œä½ çš„InsightFaceå¹´é¾„ç›‘æµ‹ç³»ç»Ÿå°†å…·å¤‡æ›´é«˜çš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§ï¼ 