<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析记录查看器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .record-card {
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chart-container {
            height: 250px;
            margin-bottom: 20px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .record-detail {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h1 class="card-title">AI人流分析记录</h1>
                        <p class="card-text">查看和管理分析记录，每条记录包含详细的人流分析数据。</p>
                        <div class="d-flex justify-content-between">
                            <div>
                                <button id="refreshBtn" class="btn btn-primary">刷新记录</button>
                                <button id="createRecordBtn" class="btn btn-success ms-2">创建记录</button>
                            </div>
                            <div>
                                <a href="/" class="btn btn-outline-secondary">返回主页</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">人数统计</h5>
                        <div class="chart-container">
                            <canvas id="peopleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">性别分布</h5>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">年龄分布</h5>
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h3>分析记录列表</h3>
                <div id="recordsList" class="row">
                    <!-- 记录将在这里动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 记录详情模态框 -->
    <div class="modal fade" id="recordDetailModal" tabindex="-1" aria-labelledby="recordDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordDetailModalLabel">记录详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="recordDetailContent">
                        <!-- 记录详情将在这里动态加载 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="exportRecordBtn">导出记录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div class="loading" id="loadingIndicator">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 全局变量
        let userId = null;
        let recordsList = [];
        let currentRecordId = null;
        let peopleChart = null;
        let genderChart = null;
        let ageChart = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL获取用户ID
            const urlParams = new URLSearchParams(window.location.search);
            userId = urlParams.get('user_id');
            
            if (!userId) {
                alert('未提供用户ID，请返回主页重新开始');
                window.location.href = '/';
                return;
            }
            
            // 初始化图表
            initCharts();
            
            // 检查分析状态
            checkAnalysisStatus();
            
            // 加载记录列表
            loadRecords();
            
            // 事件监听
            document.getElementById('refreshBtn').addEventListener('click', loadRecords);
            document.getElementById('createRecordBtn').addEventListener('click', createRecord);
            document.getElementById('exportRecordBtn').addEventListener('click', exportCurrentRecord);
        });

        // 初始化图表
        function initCharts() {
            // 人数统计图表
            const peopleCtx = document.getElementById('peopleChart').getContext('2d');
            peopleChart = new Chart(peopleCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '总人数',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: '活跃人数',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 性别分布图表 - 修改为饼图
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            genderChart = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: ['男性', '女性'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgb(54, 162, 235)',
                            'rgb(255, 99, 132)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 年龄分布图表 - 修改为饼图
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            ageChart = new Chart(ageCtx, {
                type: 'pie',
                data: {
                    labels: ['0-17', '18-25', '26-35', '36-45', '46-55', '56-65', '65+'],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 206, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)',
                            'rgb(199, 199, 199)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 检查分析状态
        async function checkAnalysisStatus() {
            try {
                const response = await fetch(`/api/status/${userId}`);
                const data = await response.json();
                
                if (!data.is_running) {
                    // 如果分析未运行，禁用创建按钮
                    const createBtn = document.getElementById('createRecordBtn');
                    createBtn.disabled = true;
                    createBtn.title = '分析未运行，无法创建新记录';
                    createBtn.classList.add('btn-secondary');
                    createBtn.classList.remove('btn-success');
                }
            } catch (error) {
                console.error('检查分析状态失败:', error);
            }
        }

        // 加载记录列表
        async function loadRecords() {
            showLoading(true);
            try {
                const response = await fetch(`/api/records/${userId}`);
                const data = await response.json();
                
                if (data.records) {
                    recordsList = data.records;
                    renderRecordsList();
                    updateCharts();
                }
            } catch (error) {
                console.error('加载记录失败:', error);
                alert('加载记录失败，请重试');
            } finally {
                showLoading(false);
            }
        }

        // 渲染记录列表
        function renderRecordsList() {
            const recordsContainer = document.getElementById('recordsList');
            recordsContainer.innerHTML = '';
            
            if (recordsList.length === 0) {
                recordsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无分析记录</div></div>';
                return;
            }
            
            recordsList.forEach(record => {
                const timestamp = new Date(record.timestamp);
                const formattedTime = timestamp.toLocaleString();
                
                const recordCard = document.createElement('div');
                recordCard.className = 'col-md-6 col-lg-4';
                recordCard.innerHTML = `
                    <div class="card record-card">
                        <div class="card-body">
                            <div class="record-header">
                                <h5 class="card-title">${record.record_name}</h5>
                                <span class="badge bg-primary">#${record.id}</span>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">${formattedTime}</h6>
                            <p class="card-text">
                                总人数: ${record.total_people}<br>
                                活跃人数: ${record.active_tracks}<br>
                                平均年龄: ${record.avg_age ? record.avg_age.toFixed(1) : 'N/A'}<br>
                                性别: 男 ${record.male_count} / 女 ${record.female_count}
                            </p>
                            <button class="btn btn-sm btn-outline-primary view-detail-btn" data-record-id="${record.id}">
                                查看详情
                            </button>
                        </div>
                    </div>
                `;
                
                recordsContainer.appendChild(recordCard);
            });
            
            // 添加详情按钮事件
            document.querySelectorAll('.view-detail-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-record-id');
                    showRecordDetail(recordId);
                });
            });
        }

        // 更新图表数据
        function updateCharts() {
            if (recordsList.length === 0) return;
            
            // 准备数据
            const labels = recordsList.map(record => {
                const date = new Date(record.timestamp);
                return date.toLocaleTimeString();
            }).reverse();
            
            const totalPeople = recordsList.map(record => record.total_people).reverse();
            const activeTracks = recordsList.map(record => record.active_tracks).reverse();
            
            // 更新人数图表
            peopleChart.data.labels = labels;
            peopleChart.data.datasets[0].data = totalPeople;
            peopleChart.data.datasets[1].data = activeTracks;
            peopleChart.update();
            
            // 更新性别图表 - 使用最新记录的数据
            if (recordsList.length > 0) {
                const latestRecord = recordsList[0];
                // 性别分布数据
                const maleCount = latestRecord.male_count || 0;
                const femaleCount = latestRecord.female_count || 0;
                
                genderChart.data.datasets[0].data = [maleCount, femaleCount];
                genderChart.update();
            }
            
            // 更新年龄分布图表 - 使用最新的记录
            if (recordsList.length > 0 && recordsList[0].additional_data && recordsList[0].additional_data.age_distribution) {
                const latestRecord = recordsList[0];
                const ageDistribution = latestRecord.additional_data.age_distribution;
                
                // 准备年龄分布数据
                const ageData = [
                    ageDistribution['0-17'] || 0,
                    ageDistribution['18-25'] || 0,
                    ageDistribution['26-35'] || 0,
                    ageDistribution['36-45'] || 0,
                    ageDistribution['46-55'] || 0,
                    ageDistribution['56-65'] || 0,
                    ageDistribution['65+'] || 0
                ];
                
                ageChart.data.datasets[0].data = ageData;
                ageChart.update();
            }
        }

        // 显示记录详情
        async function showRecordDetail(recordId) {
            showLoading(true);
            currentRecordId = recordId;
            
            try {
                const response = await fetch(`/api/record/${userId}/${recordId}`);
                const data = await response.json();
                
                if (data.record) {
                    const record = data.record;
                    const timestamp = new Date(record.timestamp);
                    const formattedTime = timestamp.toLocaleString();
                    
                    // 格式化区域数据和附加数据
                    let zoneDataHtml = '<p>无区域数据</p>';
                    if (record.zone_data && Object.keys(record.zone_data).length > 0) {
                        zoneDataHtml = '<ul>';
                        for (const [zoneName, zoneInfo] of Object.entries(record.zone_data)) {
                            zoneDataHtml += `<li>${zoneName}: 访问 ${zoneInfo.total_visits || 0} 次, 
                                           独立访客 ${zoneInfo.unique_visitors || 0} 人,
                                           平均停留 ${(zoneInfo.avg_dwell_time || 0).toFixed(1)} 秒</li>`;
                        }
                        zoneDataHtml += '</ul>';
                    }
                    
                    // 格式化年龄分布数据
                    let ageDistributionHtml = '<p>无年龄分布数据</p>';
                    if (record.additional_data && record.additional_data.age_distribution) {
                        const ageDistribution = record.additional_data.age_distribution;
                        
                        // 创建表格展示年龄分布
                        ageDistributionHtml = `
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>年龄段</th>
                                        <th>人数</th>
                                        <th>百分比</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        // 计算总人数
                        const totalPeople = Object.values(ageDistribution).reduce((sum, count) => sum + count, 0);
                        
                        // 添加每个年龄段的数据
                        const ageRanges = ['0-17', '18-25', '26-35', '36-45', '46-55', '56-65', '65+'];
                        for (const range of ageRanges) {
                            const count = ageDistribution[range] || 0;
                            const percentage = totalPeople > 0 ? (count / totalPeople * 100).toFixed(1) : '0.0';
                            
                            ageDistributionHtml += `
                                <tr>
                                    <td>${range}</td>
                                    <td>${count}</td>
                                    <td>${percentage}%</td>
                                </tr>
                            `;
                        }
                        
                        ageDistributionHtml += '</tbody></table>';
                    }
                    
                    let additionalDataHtml = '<p>无附加数据</p>';
                    if (record.additional_data && Object.keys(record.additional_data).length > 0) {
                        // 复制附加数据对象，移除已经单独显示的年龄分布
                        const additionalData = {...record.additional_data};
                        delete additionalData.age_distribution;
                        
                        if (Object.keys(additionalData).length > 0) {
                            additionalDataHtml = '<pre>' + JSON.stringify(additionalData, null, 2) + '</pre>';
                        } else {
                            additionalDataHtml = '<p>无其他附加数据</p>';
                        }
                    }
                    
                    // 填充模态框内容
                    document.getElementById('recordDetailContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h4>${record.record_name}</h4>
                                <p class="text-muted">${formattedTime}</p>
                                
                                <h5>基本信息</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td>记录ID</td>
                                        <td>${record.id}</td>
                                    </tr>
                                    <tr>
                                        <td>会话ID</td>
                                        <td>${record.session_id}</td>
                                    </tr>
                                    <tr>
                                        <td>总人数</td>
                                        <td>${record.total_people}</td>
                                    </tr>
                                    <tr>
                                        <td>活跃人数</td>
                                        <td>${record.active_tracks}</td>
                                    </tr>
                                    <tr>
                                        <td>平均年龄</td>
                                        <td>${record.avg_age ? record.avg_age.toFixed(1) : 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td>性别分布</td>
                                        <td>男 ${record.male_count} / 女 ${record.female_count}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>行为分析</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td>平均停留时间</td>
                                        <td>${record.avg_dwell_time.toFixed(1)} 秒</td>
                                    </tr>
                                    <tr>
                                        <td>参与度评分</td>
                                        <td>${record.engagement_score.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>购物者数量</td>
                                        <td>${record.shopper_count}</td>
                                    </tr>
                                    <tr>
                                        <td>浏览者数量</td>
                                        <td>${record.browser_count}</td>
                                    </tr>
                                </table>
                                
                                <h5>区域数据</h5>
                                ${zoneDataHtml}
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>年龄分布</h5>
                                ${ageDistributionHtml}
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>附加数据</h5>
                                ${additionalDataHtml}
                            </div>
                        </div>
                    `;
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('recordDetailModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('加载记录详情失败:', error);
                alert('加载记录详情失败，请重试');
            } finally {
                showLoading(false);
            }
        }

        // 创建新记录
        async function createRecord() {
            if (!confirm('确定要创建新的分析记录吗？')) return;
            
            showLoading(true);
            try {
                const recordName = prompt('请输入记录名称 (可选):', `手动记录_${new Date().toLocaleTimeString()}`);
                
                if (recordName !== null) {
                    const response = await fetch(`/api/create-record/${userId}?record_name=${encodeURIComponent(recordName)}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `服务器错误 (${response.status})`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(`成功创建分析记录: ${data.message}`);
                        loadRecords();
                    } else {
                        alert(`创建记录失败: ${data.message || '未知错误'}`);
                    }
                }
            } catch (error) {
                console.error('创建记录失败:', error);
                alert(`创建记录失败: ${error.message || '未知错误'}`);
                
                // 如果是因为分析未运行，禁用创建按钮
                if (error.message && error.message.includes('分析未运行')) {
                    document.getElementById('createRecordBtn').disabled = true;
                    document.getElementById('createRecordBtn').title = '分析未运行，无法创建新记录';
                }
            } finally {
                showLoading(false);
            }
        }

        // 导出当前记录
        async function exportCurrentRecord() {
            if (!currentRecordId) {
                alert('请先选择一条记录');
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch(`/api/export-record/${userId}?record_id=${currentRecordId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success && data.download_url) {
                    // 创建下载链接
                    const a = document.createElement('a');
                    a.href = data.download_url;
                    a.download = data.filepath.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    alert('记录导出成功，开始下载');
                } else {
                    alert(`导出记录失败: ${data.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('导出记录失败:', error);
                alert('导出记录失败，请重试');
            } finally {
                showLoading(false);
            }
        }

        // 显示/隐藏加载指示器
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html> 